name: Playwright Tests
on:
  workflow_dispatch:
  schedule:
    # Daily at 09:00 Nepal Time (NPT, UTC+05:45) = 03:15 UTC
    - cron: "15 3 * * *"
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    env:
      MS_EMAIL: ${{ secrets.MS_EMAIL }}
      MS_PASSWORD: ${{ secrets.MS_PASSWORD }}
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Validate secret bindings (safe)
      run: |
        echo "HAS_SECRET_MS_EMAIL=${{ secrets.MS_EMAIL != '' }}"
        echo "HAS_SECRET_MS_PASSWORD=${{ secrets.MS_PASSWORD != '' }}"
        echo "HAS_SECRET_SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL != '' }}"
    - name: Validate required env presence (safe)
      shell: bash
      run: |
        echo "MS_EMAIL_SET=$([ -n \"$MS_EMAIL\" ] && echo true || echo false)"
        echo "MS_PASSWORD_SET=$([ -n \"$MS_PASSWORD\" ] && echo true || echo false)"
    - name: Fail fast when required env is missing
      shell: bash
      run: |
        required=(MS_EMAIL MS_PASSWORD)
        missing=()

        for key in "${required[@]}"; do
          if [ -z "${!key}" ]; then
            missing+=("$key")
          fi
        done

        if [ ${#missing[@]} -gt 0 ]; then
          echo "Missing required secrets/env: ${missing[*]}"
          exit 1
        fi
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Run Playwright tests
      id: playwright_tests
      continue-on-error: true
      run: npx playwright test
    - name: Send Slack report
      if: ${{ always() && secrets.SLACK_WEBHOOK_URL != '' }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        PLAYWRIGHT_OUTCOME: ${{ steps.playwright_tests.outcome }}
        SLACK_TEST_DETAIL_LIMIT: "25"
      shell: bash
      run: node scripts/send-slack-report.js
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
    - name: Fail workflow if tests failed
      if: ${{ steps.playwright_tests.outcome == 'failure' }}
      run: exit 1
