name: Playwright Tests
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    env:
      MS_EMAIL: ${{ secrets.MS_EMAIL }}
      MS_PASSWORD: ${{ secrets.MS_PASSWORD }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      MAIL_TO: ${{ secrets.MAIL_TO }}
      MAIL_FROM: ${{ secrets.MAIL_FROM }}
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Run Playwright tests
      id: playwright_tests
      continue-on-error: true
      run: npx playwright test
    - name: Build email summary
      if: ${{ always() }}
      id: summary
      shell: bash
      run: |
        node <<'NODE'
        const fs = require('fs');

        const outputPath = process.env.GITHUB_OUTPUT;
        const reportPath = 'test-results/results.json';
        const runUrl = `https://github.com/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

        function summarizeSuites(suites = []) {
          const totals = { passed: 0, failed: 0, skipped: 0 };
          for (const suite of suites) {
            for (const spec of suite.specs || []) {
              for (const testCase of spec.tests || []) {
                const results = testCase.results || [];
                const final = results[results.length - 1];
                const status = final && final.status;
                if (status === 'passed') totals.passed += 1;
                else if (status === 'skipped') totals.skipped += 1;
                else totals.failed += 1;
              }
            }
            const nested = summarizeSuites(suite.suites || []);
            totals.passed += nested.passed;
            totals.failed += nested.failed;
            totals.skipped += nested.skipped;
          }
          return totals;
        }

        let status = 'FAILED';
        let totals = { passed: 0, failed: 0, skipped: 0 };

        if (fs.existsSync(reportPath)) {
          const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
          totals = summarizeSuites(report.suites || []);
          status = totals.failed > 0 ? 'FAILED' : 'PASSED';
        }

        const total = totals.passed + totals.failed + totals.skipped;
        const subject = `Timesheet Playwright Run ${status} - #${process.env.GITHUB_RUN_NUMBER}`;
        const body = [
          `Project: ${process.env.GITHUB_REPOSITORY}`,
          `Branch: ${process.env.GITHUB_REF_NAME}`,
          `Status: ${status}`,
          `Total: ${total}`,
          `Passed: ${totals.passed}`,
          `Failed: ${totals.failed}`,
          `Skipped: ${totals.skipped}`,
          '',
          `Run URL: ${runUrl}`,
        ].join('\n');

        fs.appendFileSync(outputPath, `subject=${subject}\n`);
        fs.appendFileSync(outputPath, `body<<EOF\n${body}\nEOF\n`);
        NODE
    - name: Send email report
      if: ${{ always() && env.SMTP_HOST != '' && env.SMTP_PORT != '' && env.SMTP_USER != '' && env.SMTP_PASS != '' && env.MAIL_TO != '' && env.MAIL_FROM != '' }}
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ env.SMTP_HOST }}
        server_port: ${{ env.SMTP_PORT }}
        username: ${{ env.SMTP_USER }}
        password: ${{ env.SMTP_PASS }}
        subject: ${{ steps.summary.outputs.subject }}
        body: ${{ steps.summary.outputs.body }}
        to: ${{ env.MAIL_TO }}
        from: ${{ env.MAIL_FROM }}
        secure: false
        convert_markdown: false
        attachments: test-results/results.json
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
    - name: Fail workflow if tests failed
      if: ${{ steps.playwright_tests.outcome == 'failure' }}
      run: exit 1
